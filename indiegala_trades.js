// Add page navigation to bottom of page aswell
$('.page-nav').parent().clone().insertAfter('.search-cont');
function showOwnedGames(){
	// Get App ID's && Names
	$('.trade-cont img[src*=apps]').not('.checked').addClass('checked').each(function(){
		let str = $(this).attr('src');
		let start = (str.indexOf('apps/') > 0 ? str.indexOf('apps/') : str.indexOf('dium/'));
		let end = (str.indexOf('/header.jpg') > 0 ? str.indexOf('/header.jpg') : str.indexOf('.jpg'));
		let app_id = Number(str.substring(start+5,end));
		// Check if app_id is valid
		if (isNaN(app_id)){ app_id = 0; }
		// Remove If Blacklisted
		if (typeof local_settings.blacklist_apps[app_id] != 'undefined'){
			$(this).parents('.trade-cont').remove();
			return;
		}
		// Remove/Display If Owned
		if ( !!($.inArray(app_id, local_settings.owned_apps) + 1) ){
			if (!!settings.hide_owned_games){
				$(this).parents('.trade-cont').remove();
				return;
			}else{
				$(this).parents('.trade-cont').addClass('owned').find('.main').html('(owned)');
			}
		}
		$(this).parents('.trade-cont').find('.read-more').html(`<i class="fa fa-steam" aria-hidden="true"></i> <a class="viewOnSteam" href="http://store.steampowered.com/app/${app_id}" target="_BLANK">View on Steam &rarr;</a>`);
	}).on('error', function(){
		$(this).attr('src','http://i.imgur.com/eMShBmW.png');
	});

	// TODO: re-enable
	// Add button to hide specific apps
	// $('.trade_img').not('.checked').addClass('checked').prepend('<span class="add-to-blacklist">Hide This Game <i class="fa fa-times"></i></span>');

	// Show remaining apps
	$('.trade-cont').fadeIn();
}

showOwnedGames();

// When page number clicked load that page via ajax
$(document).on('click','.page-link-cont',(e) => {
	e.preventDefault();
	// Scroll to top of section
	$('html, body').animate({
		scrollTop: $('.search-type-cont').offset().top-80
	}, 1000);
	// Hide old giveaways - show loading symbol
	$('.trades-main-page .row.no-padding').slideUp(1000,() => {
		$('.trades-main-page .row.no-padding').html('<i class="fa fa-refresh fa-5x fa-spin" id="indiegala-helper-pageloading"></i>');
		$('.trades-main-page .row.no-padding').slideDown();
	});
	// Load new giveaways
	$('.trades-main-page .row.no-padding').load(`${e.target.href} .trade-cont`,(response, status, xhr) => {
		if ( status == 'error' || xhr.status!==200){
			location.replace(e.target.href);
		}
		showOwnedGames();
		$('img').on('error', function(){
			$(this).attr('src', 'http://i.imgur.com/eMShBmW.png');
		});
	});
	// Load new page nav
	$('.page-nav .row .col-xs-12').load(`${e.target.href} .page-link-cont`,(response, status, xhr) => {
		if ( status == 'error' || xhr.status!==200){
			location.replace(e.target.href);
		}else{
			history.replaceState('data', '', e.target.href);
		}
	});
});
